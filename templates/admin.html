<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>{{ site }} — Admin</title>
    <style>
      :root{--ink:#111827;--muted:#6b7280;--rule:#e5e7eb}
      body{font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:0;color:var(--ink);background:#fff}
      .wrap{max-width:1000px;margin:0 auto;padding:20px}
      h1{font-size:22px;margin:0 0 12px}
      .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
      .card{border:1px solid var(--rule);border-radius:10px;padding:16px}
      table{width:100%;border-collapse:collapse;border:1px solid var(--rule);border-radius:10px;overflow:hidden}
      th,td{padding:8px 10px;border-bottom:1px solid var(--rule);text-align:left}
      th{background:#fafafa}
      .muted{color:var(--muted)}
      button{padding:8px 10px;border:1px solid #111;background:#fff;border-radius:8px}
      canvas{width:100%;height:260px}
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>{{ site }} — Admin</h1>
      <div class="muted">Basic auth required. Summary shows last 30 days.</div>
      <div class="grid" style="margin-top:12px">
        <div class="card">
          <h3>Top brands (clicks)</h3>
          <canvas id="brands"></canvas>
        </div>
        <div class="card">
          <h3>Top sizes (clicks)</h3>
          <canvas id="sizes"></canvas>
        </div>
      </div>
      <div class="card" style="margin-top:16px">
        <h3>Avg delivered by line</h3>
        <table id="prices"><thead><tr><th>Line</th><th>Avg delivered</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
    <script>
      async function fetchSummary(){
        const creds = btoa(prompt("Admin user:")+":"+prompt("Admin pass:"));
        const res = await fetch("/api/summary",{headers:{Authorization:"Basic "+creds}});
        if(!res.ok){ alert("Auth failed"); return; }
        const data = await res.json();
        const bc = document.getElementById('brands').getContext('2d');
        drawBars(bc, data.top_brands.map(x=>x.brand), data.top_brands.map(x=>x.clicks));
        const sc = document.getElementById('sizes').getContext('2d');
        drawBars(sc, data.top_sizes.map(x=>x.size), data.top_sizes.map(x=>x.clicks));
        const tbody = document.querySelector("#prices tbody");
        tbody.innerHTML = data.avg_delivered_by_line.map(r=>`<tr><td>${r.line}</td><td>$${(r.avg_delivered/100).toFixed(2)}</td></tr>`).join("");
      }
      function drawBars(ctx, labels, values){
        const W=ctx.canvas.width, H=ctx.canvas.height;
        ctx.clearRect(0,0,W,H);
        const max = Math.max(1,...values);
        const barW = (W-40)/Math.max(1,values.length);
        labels.forEach((lab,i)=>{
          const v = values[i];
          const h = (H-40) * (v/max);
          const x = 20 + i*barW;
          const y = H-20 - h;
          ctx.fillStyle = "#ddd"; ctx.fillRect(x, y, barW*0.7, h);
          ctx.fillStyle = "#111"; ctx.fillText(lab, x, H-6);
          ctx.fillText(String(v), x, y-4);
        });
      }
      fetchSummary();
    </script>
  </body>
</html>