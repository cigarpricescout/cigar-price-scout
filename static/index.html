<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Cigar Price Scout - Find the Best Cigar Deals with Wrapper & Vitola Search</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Compare cigar prices across 35+ online retailers. Search by brand, wrapper type, vitola, and size to find the best deals on premium cigars with shipping and tax calculations." />
    <meta name="keywords" content="cigar prices, cigar deals, wrapper types, vitola sizes, Connecticut, Maduro, Habano, cigar comparison, online cigar shopping" />
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="Cigar Price Scout - Best Cigar Price Comparison" />
    <meta property="og:description" content="Compare cigar prices across 35+ retailers. Filter by wrapper type, vitola, and size to find your perfect cigar at the best price." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://cigarpricescout.com" />
    <meta property="og:image" content="https://cigarpricescout.com/static/cigar-scout-social.png" />
    
    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Cigar Price Scout - Find the Best Cigar Deals" />
    <meta name="twitter:description" content="Compare prices on premium cigars by wrapper type, vitola, and size across 35+ online retailers." />
    <meta name="twitter:image" content="https://cigarpricescout.com/static/cigar-scout-social.png" />
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/static/logo.png">
    <link rel="apple-touch-icon" href="/static/logo.png">
    
    <!-- Schema.org Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Cigar Price Scout",
      "description": "Compare cigar prices across multiple online retailers with advanced filtering by wrapper type, vitola, and size",
      "url": "https://cigarpricescout.com",
      "applicationCategory": "Shopping",
      "operatingSystem": "Any",
      "offers": {
        "@type": "Offer",
        "category": "Cigars",
        "availability": "https://schema.org/InStock"
      }
    }
    </script>
    
    <!-- Sherlock-esque fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet" />
    
    <style>
      :root{
        --ink:#111;
        --muted:#4b5563;
        --rule:#e5e7eb;
        --accent:#7c5c2e;
      }
      body{
        margin:0;
        color:var(--ink);
        background:#faf7f2;
        font-family:"Cormorant Garamond", serif;
        font-size:18px;
        line-height:1.5;
      }
      .wrap{max-width:900px;margin:0 auto;padding:0 20px}
      
      /* Header: scout hat, title, tagline stacked and centered */
      .heroheader{
        display:flex;flex-direction:column;align-items:center;justify-content:center;
        gap:8px;padding:28px 0 10px;text-align:center;
      }
      .scout-hat{width:100px;height:80px;object-fit:contain}
      .brandname{
        font-family:"Cinzel", serif;
        font-weight:700;
        letter-spacing:.4px;
        font-size:28px;
      }
      .tag{
        font-style:italic;
        color:var(--muted);
        font-size:20px;
        margin-top:2px;
      }
      .last-updated{
        font-size:14px;
        color:var(--muted);
        margin-top:8px;
        font-style:italic;
      }
      
      /* Enhanced Picker with wrapper support */
      .picker{
        display:grid;
        grid-template-columns:1fr 1fr 1fr 1fr 140px 200px;
        gap:10px;margin:18px auto;
      }
      .picker select,.picker input{
        padding:12px 14px;border:1px solid var(--rule);border-radius:12px;background:#fff;
        font-family:"Cormorant Garamond", serif;font-size:18px;
      }
      .cta{border:none;border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
      .cta-primary{background:var(--accent);color:#fff}
      .cta-primary:hover{filter:brightness(.95)}
      .cta:disabled{opacity:0.5;cursor:not-allowed}
      .cta svg{width:18px;height:18px}
      .chips{display:flex;gap:8px;justify-content:center;margin-top:12px;flex-wrap:wrap}
      .chip{font-size:14px;padding:6px 10px;border-radius:999px;border:1px solid var(--rule);background:#fff;color:#374151}
      h2{font-family:"Cinzel", serif;font-weight:700;letter-spacing:.3px;margin:18px 0 8px;font-size:24px}
      
      /* Clean, Professional Table Styling with Enhanced Readability */
      table{
        width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--rule);
        border-radius:12px;overflow:hidden;margin-top:20px;
        box-shadow:0 1px 3px rgba(0,0,0,0.05);
        min-width:1000px;
      }
      th,td{
        padding:20px 16px;border-bottom:1px solid var(--rule);text-align:left;
        font-size:18px;line-height:1.6;
      }
      th{
        background:#fcfbf9;color:var(--ink);font-family:"Cinzel", serif;
        font-weight:600;font-size:16px;letter-spacing:0.3px;
      }
      td{color:var(--ink);background:#fff}
      
      /* Column widths for proper spacing */
      .retailer-col { width: 180px; }
      .dealer-col { width: 140px; }
      .product-col { width: 320px; }
      .base-col { width: 100px; }
      .shipping-col { width: 90px; }
      .tax-col { width: 80px; }
      .total-col { width: 110px; }
      .status-col { width: 90px; }
      
      /* Enhanced Product Details Spacing */
      .product-details{
        display:flex;
        flex-direction:column;
        gap:8px;
        line-height:1.5;
      }
      .product-name{
        font-weight:600;
        font-size:17px;
        color:var(--ink);
        margin-bottom:6px;
      }
      .product-specs{
        display:flex;
        gap:8px;
        flex-wrap:wrap;
        font-size:14px;
        color:var(--muted);
        align-items:center;
      }
      
      /* Marketplace Warning Design */
      .marketplace-cell{
        display:flex;
        flex-direction:column;
        gap:4px;
        align-items:center;
        text-align:center;
      }
      .marketplace-warning{
        font-size:15px;
        color:#dc2626;
        font-weight:600;
        display:flex;
        align-items:center;
        gap:6px;
        justify-content:center;
      }
      .risk-text{
        font-size:12px;
        color:#dc2626;
        font-weight:500;
        text-align:center;
        line-height:1.2;
      }
      .hazard-icon{
        width:16px;
        height:16px;
        fill:#dc2626;
      }
      
      /* Authorized Dealer Indicators */
      .auth-badge{
        display:inline-block;
        padding:6px 10px;
        border-radius:6px;
        font-size:13px;
        font-weight:600;
        text-transform:uppercase;
      }
      .auth-badge.marketplace{
        background:#fef2f2;
        color:#dc2626;
        border:1px solid #fecaca;
      }
      
      /* Status indicators */
      .oos{color:#dc2626;font-weight:600;font-size:14px;text-transform:uppercase}
      .best{color:#059669;font-weight:700;font-size:14px;text-transform:uppercase}
      
      /* Links styling */
      td a{color:var(--accent);text-decoration:none;font-weight:600;font-size:19px}
      td a:hover{text-decoration:underline}
      
      /* Wrapper and vitola badges */
      .wrapper-badge{
        display:inline-block;
        background:#f3f4f6;
        color:#374151;
        padding:6px 12px;
        border-radius:8px;
        font-size:15px;
        font-weight:600;
        margin-right:8px;
      }
      .vitola-badge{
        display:inline-block;
        background:#e0f2fe;
        color:#0369a1;
        padding:6px 12px;
        border-radius:8px;
        font-size:15px;
        font-weight:600;
      }
      
      /* Price columns styling */
      .price-cell{
        font-weight:600;
        font-size:20px;
      }
      .total-price{
        font-weight:700;
        font-size:21px;
        color:var(--accent);
      }
      
      /* Responsive design */
      @media(max-width:768px){
        .picker{
          grid-template-columns:1fr;
          gap:12px;
        }
        .heroheader{padding:20px 0 8px}
        .brandname{font-size:24px}
        .tag{font-size:18px}
        table{font-size:15px}
        th,td{padding:10px 12px}
      }
      
      /* Footer */
      .footer{
        margin-top:40px;
        padding:20px 0;
        border-top:1px solid var(--rule);
        text-align:center;
        color:var(--muted);
        font-size:16px;
      }
      .footer a{color:var(--accent);text-decoration:none}
      .footer a:hover{text-decoration:underline}
    </style>
  </head>
  
  <body>
    <!-- Age Verification Modal -->
    <div id="ageModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center;">
      <div style="background:#fff;padding:40px;border-radius:12px;text-align:center;max-width:400px;margin:20px;">
        <h2 style="font-family:'Cinzel',serif;margin-bottom:20px;">Age Verification Required</h2>
        <p style="margin-bottom:30px;font-size:18px;line-height:1.5;">You must be 21 years or older to view cigar pricing information. Please confirm your age to continue.</p>
        <div style="display:flex;gap:15px;justify-content:center;">
          <button onclick="confirmAge()" style="background:var(--accent);color:#fff;padding:12px 24px;border:none;border-radius:8px;font-size:16px;cursor:pointer;">I am 21 or older</button>
          <button onclick="denyAge()" style="background:#dc2626;color:#fff;padding:12px 24px;border:none;border-radius:8px;font-size:16px;cursor:pointer;">I am under 21</button>
        </div>
      </div>
    </div>

    <div class="wrap">
      <header class="heroheader">
        <img src="/static/logo.png" alt="Cigar Price Scout Logo" class="scout-hat" />
        <h1 class="brandname">Cigar Price Scout</h1>
        <p class="tag">Search the cigar box, we'll scout the stock</p>
        <div class="last-updated">Data last updated: September 2, 2025</div>
        <div style="font-size:13px;color:var(--muted);margin-top:4px;font-style:italic;">
          Stock status verification coming in next update
        </div>
      </header>
      
      <main>
        <section class="picker">
          <select id="brandSelect" aria-label="Select cigar brand">
            <option value="">Select Brand...</option>
          </select>
          
          <select id="lineSelect" disabled aria-label="Select cigar line">
            <option value="">Select Line...</option>
          </select>
          
          <select id="wrapperSelect" disabled aria-label="Select wrapper type">
            <option value="">Any Wrapper...</option>
          </select>
          
          <select id="vitolaSelect" disabled aria-label="Select vitola">
            <option value="">Any Vitola...</option>
          </select>
          
          <input type="text" id="zipInput" placeholder="ZIP code" aria-label="ZIP code for shipping calculation" />
          
          <button class="cta cta-primary" id="searchBtn" disabled>
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
            Find Deals
          </button>
        </section>
        
        <div class="chips" id="filterChips"></div>
        
        <section id="results" style="display:none">
          <h2 id="resultsTitle">Price Comparison Results</h2>
          
          <!-- Cost Savings Summary -->
          <div id="savingsSummary" style="background:#f0f9ff;border:1px solid #0284c7;border-radius:8px;padding:16px;margin-bottom:20px;display:none;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div>
                <strong style="color:#0369a1;font-size:18px;">Potential Savings: <span id="savingsAmount"></span></strong>
                <div style="font-size:14px;color:#0369a1;margin-top:4px;">Cheapest vs Most Expensive</div>
              </div>
              <div style="text-align:right;font-size:14px;color:#374151;">
                <div>Cheapest: <strong id="cheapestPrice"></strong></div>
                <div>Most Expensive: <strong id="expensivePrice"></strong></div>
              </div>
            </div>
          </div>
          
          <table id="resultsTable">
            <thead>
              <tr>
                <th class="retailer-col">Retailer</th>
                <th class="dealer-col">Dealer Type</th>
                <th class="product-col">Product Details</th>
                <th class="base-col">Base Price</th>
                <th class="shipping-col">Shipping</th>
                <th class="tax-col">Tax</th>
                <th class="total-col">Total</th>
                <th class="status-col">Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>
      </main>
      
      <footer class="footer">
        <p>
          <a href="/about.html">About</a> | 
          <a href="/privacy-policy.html">Privacy</a> | 
          <a href="/terms-of-service.html">Terms</a> | 
          <a href="/contact.html">Contact</a>
        </p>
        <p>&copy; 2025 Cigar Price Scout. Prices and availability subject to change.</p>
      </footer>
    </div>

    <script>
      let optionsData = null;
      let currentSelection = {
        brand: '',
        line: '',
        wrapper: '',
        vitola: ''
      };

      // DOM elements
      const brandSelect = document.getElementById('brandSelect');
      const lineSelect = document.getElementById('lineSelect');
      const wrapperSelect = document.getElementById('wrapperSelect');
      const vitolaSelect = document.getElementById('vitolaSelect');
      const zipInput = document.getElementById('zipInput');
      const searchBtn = document.getElementById('searchBtn');
      const filterChips = document.getElementById('filterChips');
      const resultsSection = document.getElementById('results');
      const resultsTitle = document.getElementById('resultsTitle');
      const resultsTable = document.getElementById('resultsTable');

      // Age verification functions
      let ageVerified = false;
      
      function showAgeModal() {
        if (!ageVerified) {
          document.getElementById('ageModal').style.display = 'flex';
        }
      }
      
      function confirmAge() {
        ageVerified = true;
        document.getElementById('ageModal').style.display = 'none';
      }
      
      function denyAge() {
        alert('You must be 21 or older to access this site.');
        window.location.href = 'https://www.google.com';
      }

      // Load options on page load
      async function loadOptions() {
        try {
          const response = await fetch('/options');
          const data = await response.json();
          optionsData = data.brands;
          populateBrandSelect();
        } catch (error) {
          console.error('Error loading options:', error);
        }
      }

      function populateBrandSelect() {
        brandSelect.innerHTML = '<option value="">Select Brand...</option>';
        optionsData.forEach(brand => {
          const option = document.createElement('option');
          option.value = brand.brand;
          option.textContent = brand.brand;
          brandSelect.appendChild(option);
        });
      }

      function populateLineSelect() {
        lineSelect.innerHTML = '<option value="">Select Line...</option>';
        lineSelect.disabled = !currentSelection.brand;
        
        if (currentSelection.brand) {
          const brand = optionsData.find(b => b.brand === currentSelection.brand);
          if (brand) {
            brand.lines.forEach(line => {
              const option = document.createElement('option');
              option.value = line.line;
              option.textContent = line.line;
              lineSelect.appendChild(option);
            });
          }
        }
      }

      function populateWrapperSelect() {
        wrapperSelect.innerHTML = '<option value="">Any Wrapper...</option>';
        wrapperSelect.disabled = !currentSelection.line;
        
        if (currentSelection.brand && currentSelection.line) {
          const brand = optionsData.find(b => b.brand === currentSelection.brand);
          const line = brand?.lines.find(l => l.line === currentSelection.line);
          
          if (line) {
            // Get unique wrappers
            const wrappers = [...new Set(line.wrappers.map(w => w.wrapper).filter(w => w))];
            wrappers.forEach(wrapper => {
              const option = document.createElement('option');
              option.value = wrapper;
              option.textContent = wrapper;
              wrapperSelect.appendChild(option);
            });
          }
        }
      }

      function populateVitolaSelect() {
        vitolaSelect.innerHTML = '<option value="">Any Vitola...</option>';
        vitolaSelect.disabled = !currentSelection.line;
        
        if (currentSelection.brand && currentSelection.line) {
          const brand = optionsData.find(b => b.brand === currentSelection.brand);
          const line = brand?.lines.find(l => l.line === currentSelection.line);
          
          if (line) {
            // Get unique vitolas
            const vitolas = [...new Set(line.wrappers.flatMap(w => w.vitolas).filter(v => v))];
            vitolas.forEach(vitola => {
              const option = document.createElement('option');
              option.value = vitola;
              option.textContent = vitola;
              vitolaSelect.appendChild(option);
            });
          }
        }
      }

      function updateFilterChips() {
        const chips = [];
        if (currentSelection.brand) chips.push(`Brand: ${currentSelection.brand}`);
        if (currentSelection.line) chips.push(`Line: ${currentSelection.line}`);
        if (currentSelection.wrapper) chips.push(`Wrapper: ${currentSelection.wrapper}`);
        if (currentSelection.vitola) chips.push(`Vitola: ${currentSelection.vitola}`);
        
        filterChips.innerHTML = chips.map(chip => 
          `<span class="chip">${chip}</span>`
        ).join('');
      }

      function updateSearchButton() {
        const canSearch = currentSelection.brand && currentSelection.line;
        searchBtn.disabled = !canSearch;
      }

      // Event listeners
      brandSelect.addEventListener('change', (e) => {
        currentSelection.brand = e.target.value;
        currentSelection.line = '';
        currentSelection.wrapper = '';
        currentSelection.vitola = '';
        
        lineSelect.value = '';
        wrapperSelect.value = '';
        vitolaSelect.value = '';
        
        populateLineSelect();
        populateWrapperSelect();
        populateVitolaSelect();
        updateFilterChips();
        updateSearchButton();
      });

      lineSelect.addEventListener('change', (e) => {
        currentSelection.line = e.target.value;
        currentSelection.wrapper = '';
        currentSelection.vitola = '';
        
        wrapperSelect.value = '';
        vitolaSelect.value = '';
        
        populateWrapperSelect();
        populateVitolaSelect();
        updateFilterChips();
        updateSearchButton();
      });

      wrapperSelect.addEventListener('change', (e) => {
        currentSelection.wrapper = e.target.value;
        updateFilterChips();
      });

      vitolaSelect.addEventListener('change', (e) => {
        currentSelection.vitola = e.target.value;
        updateFilterChips();
      });

      searchBtn.addEventListener('click', async () => {
        if (!currentSelection.brand || !currentSelection.line) return;
        
        const params = new URLSearchParams({
          brand: currentSelection.brand,
          line: currentSelection.line,
          zip: zipInput.value
        });
        
        if (currentSelection.wrapper) params.append('wrapper', currentSelection.wrapper);
        if (currentSelection.vitola) params.append('vitola', currentSelection.vitola);
        
        try {
          searchBtn.disabled = true;
          searchBtn.textContent = 'Searching...';
          
          const response = await fetch(`/compare?${params}`);
          const data = await response.json();
          
          displayResults(data);
        } catch (error) {
          console.error('Search error:', error);
          alert('Search failed. Please try again.');
        } finally {
          searchBtn.disabled = false;
          searchBtn.innerHTML = `
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
            Find Deals
          `;
        }
      });

      function displayResults(data) {
        if (!data.results || data.results.length === 0) {
          resultsTitle.textContent = 'No results found';
          resultsTable.querySelector('tbody').innerHTML = '<tr><td colspan="8">No matching cigars found.</td></tr>';
          resultsSection.style.display = 'block';
          return;
        }
        
        // Update title
        let titleParts = [data.brand, data.line];
        if (data.wrapper) titleParts.push(data.wrapper);
        if (data.vitola) titleParts.push(data.vitola);
        resultsTitle.textContent = `${titleParts.join(' ')} - Price Comparison`;
        
        // Build table rows with proper column structure
        const tbody = resultsTable.querySelector('tbody');
        tbody.innerHTML = data.results.map(result => {
          return `
          <tr>
            <td class="retailer-col">
              <a href="${result.url}" target="_blank">${result.retailer}</a>
            </td>
            <td class="dealer-col">
              <div class="marketplace-cell">
                <div class="marketplace-warning">
                  <svg class="hazard-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2L1 21h22L12 2zm0 3.5L19.5 19h-15L12 5.5zM11 10v4h2v-4h-2zm0 6v2h2v-2h-2z"/>
                  </svg>
                  <span class="auth-badge marketplace">Marketplace</span>
                </div>
                <div class="risk-text">Buy at own risk</div>
              </div>
            </td>
            <td class="product-col">
              <div class="product-details">
                <div class="product-name">${result.product}</div>
                <div class="product-specs">
                  ${result.wrapper ? `<span class="wrapper-badge">${result.wrapper}</span>` : ''}
                  ${result.vitola ? `<span class="vitola-badge">${result.vitola}</span>` : ''}
                  <span>Size: ${result.size}</span>
                </div>
              </div>
            </td>
            <td class="price-cell base-col">${result.base}</td>
            <td class="price-cell shipping-col">${result.shipping}</td>
            <td class="price-cell tax-col">${result.tax}</td>
            <td class="price-cell total-price total-col">${result.delivered_after_promo}</td>
            <td class="status-col">
              ${result.oos ? '<span class="oos">Out of Stock</span>' : ''}
              ${result.cheapest ? '<span class="best">Best Deal</span>' : ''}
            </td>
          </tr>
          `;
        }).join('');
        
        // Calculate and display cost savings
        if (data.results.length > 1) {
          const inStockResults = data.results.filter(r => !r.oos);
          if (inStockResults.length > 1) {
            const prices = inStockResults.map(r => parseFloat(r.delivered_after_promo.replace('$', '')));
            const cheapest = Math.min(...prices);
            const mostExpensive = Math.max(...prices);
            const savings = mostExpensive - cheapest;
            
            if (savings > 0) {
              document.getElementById('cheapestPrice').textContent = `$${cheapest.toFixed(2)}`;
              document.getElementById('expensivePrice').textContent = `$${mostExpensive.toFixed(2)}`;
              document.getElementById('savingsAmount').textContent = `$${savings.toFixed(2)}`;
              document.getElementById('savingsSummary').style.display = 'block';
            }
          }
        }
        
        resultsSection.style.display = 'block';
        resultsSection.scrollIntoView({ behavior: 'smooth' });
      }

      // Initialize and show age modal
      loadOptions();
      window.addEventListener('load', showAgeModal);
    </script>
  </body>
</html>