<!doctype html>
<html lang="en">
<head>
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QV9XYRECFK"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-QV9XYRECFK');
  </script>
  
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cigar Price Scout - Find the Best Cigar Deals with Wrapper & Vitola Search</title>
  
  <!-- Verification Tags -->
  <meta name="fo-verify" content="cc05d5b4-848a-4809-b7d9-5c4ae620bb8f" />
  <meta name='impact-site-verification' value='8827da88-cb8b-450d-934b-22aff8541f4b'>
  
  <!-- SEO Meta Tags -->
  <meta name="description" content="Compare cigar prices across 35+ online retailers. Search by brand, wrapper type, vitola, and size to find the best deals on premium cigars with shipping and tax calculations." />
  <meta name="keywords" content="cigar prices, cigar box prices, cigar box deals, cigar deals, wrapper types, vitola sizes, Connecticut, Maduro, Habano, cigar comparison, online cigar shopping" />
  
  <!-- Canonical URL -->
  <link rel="canonical" href="https://cigarpricescout.com/" />
  
  <!-- Open Graph Tags -->
  <meta property="og:title" content="Cigar Price Scout - Best Cigar Price Comparison" />
  <meta property="og:description" content="Compare cigar prices across 35+ retailers. Filter by wrapper type, vitola, and size to find your perfect cigar at the best price." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://cigarpricescout.com" />
  <meta property="og:image" content="https://cigarpricescout.com/static/cigar-scout-social.png" />
  
  <!-- Twitter Cards -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Cigar Price Scout - Find the Best Cigar Deals" />
  <meta name="twitter:description" content="Compare prices on premium cigars by wrapper type, vitola, and size across 35+ online retailers." />
  <meta name="twitter:image" content="https://cigarpricescout.com/static/cigar-scout-social.png" />
  
  <!-- Canonical URL -->
  <link rel="canonical" href="https://cigarpricescout.com/" />
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/static/logo.png">
  <link rel="apple-touch-icon" href="/static/logo.png">
  
  <!-- Schema.org -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": ["WebSite", "WebApplication"],
    "name": "Cigar Price Scout",
    "alternateName": "CigarPriceScout.com",
    "url": "https://cigarpricescout.com",
    "description": "Compare cigar prices across 35+ online retailers. Search by brand, wrapper type, vitola, and size to find the best deals on premium cigars with shipping and tax calculations.",
    "applicationCategory": "Shopping",
    "operatingSystem": "Any",
    "browserRequirements": "Requires JavaScript",
    "potentialAction": [{
      "@type": "SearchAction",
      "target": {
        "@type": "EntryPoint",
        "urlTemplate": "https://cigarpricescout.com/compare?brand={brand}&line={line}&wrapper={wrapper}&vitola={vitola}&zip={zip_code}"
      },
      "query-input": ["required name=brand", "required name=line", "name=wrapper", "name=vitola", "name=zip_code"]
    }],
    "publisher": {
      "@type": "Organization",
      "name": "Cigar Price Scout",
      "url": "https://cigarpricescout.com",
      "logo": {"@type": "ImageObject", "url": "https://cigarpricescout.com/static/logo.png", "width": 100, "height": 80}
    }
  }
  </script>
  
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            // Custom brand colors
            brand: {
              50: '#faf7f2',
              100: '#f5efe5',
              200: '#e8dcc8',
              300: '#d9c5a5',
              400: '#c9a97c',
              500: '#7c5c2e',  // Primary accent (your current --accent)
              600: '#6b4f27',
              700: '#5a4220',
              800: '#493519',
              900: '#382812',
            },
            ink: '#111111',
            muted: '#4b5563',
          },
          fontFamily: {
            serif: ['Cormorant Garamond', 'Georgia', 'serif'],
            display: ['Cinzel', 'Georgia', 'serif'],
          },
        },
      },
    }
  </script>
  
  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet" />
  
  <style>
    [x-cloak] { display: none !important; }
  </style>
</head>

<body class="bg-brand-50 font-serif text-ink text-lg leading-relaxed" x-data="cigarScout()" x-init="init()">
  
  <!-- Age Verification Modal -->
  <div x-show="!ageVerified" x-cloak
       class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center">
    <div class="bg-white p-10 rounded-xl text-center max-w-md mx-auto shadow-2xl">
      <h2 class="font-display font-bold text-2xl mb-5">Age Verification Required</h2>
      <p class="mb-8 text-lg leading-relaxed">
        You must be 21 years or older to view cigar pricing information. Please confirm your age to continue.
      </p>
      <div class="flex gap-4 justify-center">
        <button @click="confirmAge()" 
                class="bg-brand-500 hover:bg-brand-600 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg">
          I am 21 or older
        </button>
        <button @click="denyAge()" 
                class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg">
          I am under 21
        </button>
      </div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="max-w-6xl mx-auto px-5">
    
    <!-- Header -->
    <header class="flex flex-col items-center justify-center gap-2 py-7 text-center">
      <img src="/static/logo.png" alt="Cigar Price Scout Logo" class="w-24 h-20 object-contain" />
      <h1 class="font-display font-bold text-3xl tracking-wide">Cigar Price Scout</h1>
      <p class="italic text-muted text-xl mt-1">
        Search your cigar - we'll scout the lowest prices on full boxes (20+ cigars, or otherwise requested)
      </p>
    </header>
    
    <!-- Main Content -->
    <main>
      <!-- Search Form -->
      <section class="grid grid-cols-1 md:grid-cols-7 gap-2 my-5">
        <!-- Brand Select -->
        <select x-model="selection.brand" 
                @change="onBrandChange()"
                class="col-span-1 p-3 border border-gray-200 rounded-xl bg-white font-serif text-lg focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-400 transition-all">
          <option value="">Select Brand...</option>
          <template x-for="brand in options" :key="brand.brand">
            <option :value="brand.brand" x-text="brand.brand"></option>
          </template>
        </select>
        
        <!-- Line Select -->
        <select x-model="selection.line" 
                @change="onLineChange()"
                :disabled="!selection.brand"
                class="col-span-1 p-3 border border-gray-200 rounded-xl bg-white font-serif text-lg focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-400 transition-all disabled:bg-gray-100 disabled:cursor-not-allowed">
          <option value="">Select Line...</option>
          <template x-for="line in availableLines" :key="line.line">
            <option :value="line.line" x-text="line.line"></option>
          </template>
        </select>
        
        <!-- Wrapper Select -->
        <select x-model="selection.wrapper" 
                @change="onWrapperChange()"
                :disabled="!selection.line"
                class="col-span-1 p-3 border border-gray-200 rounded-xl bg-white font-serif text-lg focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-400 transition-all disabled:bg-gray-100 disabled:cursor-not-allowed">
          <option value="">Any Wrapper...</option>
          <template x-for="wrapper in availableWrappers" :key="wrapper">
            <option :value="wrapper" x-text="wrapper"></option>
          </template>
        </select>
        
        <!-- Vitola Select -->
        <select x-model="selection.vitola" 
                @change="onVitolaChange()"
                :disabled="!selection.wrapper"
                class="col-span-1 p-3 border border-gray-200 rounded-xl bg-white font-serif text-lg focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-400 transition-all disabled:bg-gray-100 disabled:cursor-not-allowed">
          <option value="">Any Vitola...</option>
          <template x-for="vitola in availableVitolas" :key="vitola">
            <option :value="vitola" x-text="vitola"></option>
          </template>
        </select>
        
        <!-- Box Qty (Read-only) -->
        <input type="text" 
               :value="boxQtyDisplay" 
               readonly 
               placeholder="Box Qty"
               class="p-3 border border-gray-200 rounded-xl bg-gray-100 font-serif text-lg text-muted cursor-not-allowed" />
        
        <!-- ZIP Input -->
        <input type="text" 
               x-model="selection.zip" 
               placeholder="ZIP"
               maxlength="5"
               class="p-3 border border-gray-200 rounded-xl bg-white font-serif text-lg focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-400 transition-all" />
        
        <!-- Search Button -->
        <button @click="search()" 
                :disabled="!canSearch || isSearching"
                class="flex items-center justify-center gap-2 p-3 bg-brand-500 hover:bg-brand-600 text-white font-bold rounded-xl transition-all duration-200 shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-brand-500">
          <svg x-show="!isSearching" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
          </svg>
          <svg x-show="isSearching" class="w-5 h-5 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="10" stroke-width="4" class="opacity-25"></circle>
            <path d="M4 12a8 8 0 018-8" stroke-width="4" class="opacity-75"></path>
          </svg>
          <span x-text="isSearching ? 'Searching...' : 'Scout'"></span>
        </button>
      </section>
      
      <!-- Authorized Dealer Filter -->
      <div class="flex justify-center my-3">
        <label class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
          <input type="checkbox" x-model="authorizedOnly" class="w-4 h-4 accent-brand-500 cursor-pointer" />
          <span class="font-medium">Show Authorized Dealers Only</span>
        </label>
      </div>
      
      <!-- Action Buttons -->
      <div class="flex justify-center gap-4 my-5 flex-wrap">
        <a href="/request-box-pricing.html" 
           class="inline-block bg-brand-500 hover:bg-brand-600 text-white py-3 px-6 rounded-lg font-semibold text-lg transition-all duration-200 shadow-md hover:shadow-lg hover:-translate-y-0.5">
          Request a Box to Scout
        </a>
        <a href="#" 
           @click.prevent="reportIssue()"
           class="inline-block bg-red-600 hover:bg-red-700 text-white py-3 px-6 rounded-lg font-semibold text-lg transition-all duration-200 shadow-md hover:shadow-lg hover:-translate-y-0.5">
          Report a Data Issue
        </a>
      </div>
      
      <!-- Filter Chips -->
      <div class="flex gap-2 justify-center mt-3 flex-wrap" x-show="hasFilters">
        <template x-for="chip in filterChips" :key="chip">
          <span class="text-sm px-3 py-1.5 rounded-full border border-gray-200 bg-white text-gray-700" x-text="chip"></span>
        </template>
      </div>
      
      <!-- Results Section -->
      <section x-show="showResults" x-cloak class="mt-6">
        <h2 class="font-display font-bold text-2xl text-center tracking-wide mb-2" x-text="resultsTitle"></h2>
        
        <!-- Affiliate Disclosure -->
        <div class="bg-yellow-50 border border-yellow-200 p-3 my-4 text-yellow-800 text-sm font-bold text-center max-w-3xl mx-auto rounded-lg">
          <strong>Disclosure:</strong> We earn a commission when you purchase through our affiliate links. This helps support our price comparison service at no extra cost to you.
        </div>
        
        <!-- Best Delivered Price Answer Block -->
        <div x-show="results.length > 0 && getCheapestResult()" x-cloak
             class="bg-white border-2 border-emerald-500 rounded-xl overflow-hidden shadow-sm mb-6">
          <!-- Top: Main Answer -->
          <div class="bg-emerald-50 border-b border-emerald-200 px-6 py-5">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
              <div class="text-center md:text-left">
                <p class="text-sm font-display font-semibold text-emerald-700 uppercase tracking-wide mb-1">
                  Best Delivered Price
                </p>
                <p class="text-4xl font-bold text-emerald-600" x-text="getCheapestResult()?.delivered_after_promo"></p>
              </div>
              <div class="text-center md:text-right">
                <p class="text-sm text-muted mb-1">Cheapest at</p>
                <p class="text-2xl font-semibold text-gray-900" x-text="getCheapestResult()?.retailer"></p>
              </div>
            </div>
          </div>
          
          <!-- Bottom: Stats -->
          <div class="flex flex-col sm:flex-row divide-y sm:divide-y-0 sm:divide-x divide-gray-200">
            <div class="flex-1 text-center p-4">
              <div class="text-xs text-muted uppercase tracking-wide mb-1">Advertised</div>
              <div class="text-lg font-semibold text-gray-700" x-text="getCheapestResult()?.base"></div>
            </div>
            <div class="flex-1 text-center p-4">
              <div class="text-xs text-muted uppercase tracking-wide mb-1">Shipping</div>
              <div class="text-lg font-semibold" 
                   :class="getCheapestResult()?.shipping === '$0.00' ? 'text-emerald-600' : 'text-gray-700'"
                   x-text="getCheapestResult()?.shipping === '$0.00' ? 'Free' : getCheapestResult()?.shipping"></div>
            </div>
            <div class="flex-1 text-center p-4">
              <div class="text-xs text-muted uppercase tracking-wide mb-1">Tax</div>
              <div class="text-lg font-semibold text-gray-700" x-text="getCheapestResult()?.tax"></div>
            </div>
            <div class="flex-1 text-center p-4">
              <div class="text-xs text-muted uppercase tracking-wide mb-1">Compared</div>
              <div class="text-lg font-semibold text-gray-700" x-text="results.length + ' retailers'"></div>
            </div>
          </div>
        </div>
        
        <!-- Desktop Table -->
        <style>
          /* Table visible by default, cards hidden */
          .mobile-cards { display: none; }
          
          /* Only on small mobile screens, swap to cards */
          @media (max-width: 480px) {
            .desktop-table { display: none !important; }
            .mobile-cards { display: block !important; }
          }
        </style>
        <div class="desktop-table overflow-x-auto">
          <table class="w-full border-collapse bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm">
            <thead>
              <tr class="bg-gray-50">
                <th class="p-3 border-b border-gray-200 text-left font-display font-semibold text-sm">Retailer</th>
                <th class="p-3 border-b border-gray-200 text-center font-display font-semibold text-sm">Dealer Type</th>
                <th class="p-3 border-b border-gray-200 text-center font-display font-semibold text-sm">Advertised Price</th>
                <th class="p-3 border-b border-gray-200 text-center font-display font-semibold text-sm">Current Promo</th>
                <th class="p-3 border-b border-gray-200 text-center font-display font-semibold text-sm">Est. Shipping</th>
                <th class="p-3 border-b border-gray-200 text-center font-display font-semibold text-sm">Est. Tax</th>
                <th class="p-3 border-b border-gray-200 text-center font-display font-semibold text-sm font-bold">Est. Total</th>
                <th class="p-3 border-b border-gray-200 text-center font-display font-semibold text-sm">Stock Status</th>
                <th class="p-3 border-b border-gray-200 text-center font-display font-semibold text-sm">
                  Price Context
                  <span class="text-gray-400 text-xs cursor-help" title="Based on 10% median price threshold">?</span>
                </th>
              </tr>
            </thead>
            <tbody>
              <template x-for="(result, index) in results" :key="index">
                <tr class="hover:bg-gray-50 transition-colors">
                  <!-- Retailer -->
                  <td class="p-3 border-b border-gray-200">
                    <a :href="getTrackingUrl(result)" 
                       target="_blank" 
                       rel="noopener"
                       class="text-brand-500 hover:underline font-semibold text-lg"
                       x-text="result.retailer"></a>
                  </td>
                  
                  <!-- Dealer Type -->
                  <td class="p-3 border-b border-gray-200 text-center">
                    <div class="flex flex-col items-center gap-1">
                      <span x-show="result.authorized" 
                            class="inline-block px-2 py-1 rounded text-xs font-semibold uppercase bg-emerald-100 text-emerald-700 border border-emerald-300">
                        Authorized Dealer
                      </span>
                      <span x-show="!result.authorized" 
                            class="inline-block px-2 py-1 rounded text-xs font-semibold uppercase bg-red-50 text-red-600 border border-red-200">
                        Marketplace
                      </span>
                      <span x-show="!result.authorized" class="text-xs text-red-600 font-medium">Buy at own risk</span>
                    </div>
                  </td>
                  
                  <!-- Advertised Price -->
                  <td class="p-3 border-b border-gray-200 text-center font-semibold text-lg" x-text="result.base"></td>
                  
                  <!-- Current Promo -->
                  <td class="p-3 border-b border-gray-200 text-center">
                    <div x-html="formatPromo(result)"></div>
                  </td>
                  
                  <!-- Shipping -->
                  <td class="p-3 border-b border-gray-200 text-center font-semibold" x-text="result.shipping"></td>
                  
                  <!-- Tax -->
                  <td class="p-3 border-b border-gray-200 text-center font-semibold" x-text="result.tax"></td>
                  
                  <!-- Est. Total -->
                  <td class="p-3 border-b border-gray-200 text-center font-bold text-xl"
                      :class="result.cheapest ? 'text-emerald-600' : 'text-brand-500'"
                      x-text="result.delivered_after_promo"></td>
                  
                  <!-- Stock Status -->
                  <td class="p-3 border-b border-gray-200 text-center">
                    <span x-show="result.oos" class="text-red-600 font-semibold text-sm uppercase">Out of Stock</span>
                    <span x-show="!result.oos" class="text-emerald-600 font-semibold">In Stock</span>
                  </td>
                  
                  <!-- Price Context -->
                  <td class="p-3 border-b border-gray-200 text-center font-bold text-lg"
                      :class="{
                        'text-emerald-600': result.price_context === 'Value',
                        'text-gray-500': result.price_context === 'Market',
                        'text-blue-600': result.price_context === 'Premium'
                      }"
                      x-text="result.price_context || ''"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        
        <!-- Mobile Cards -->
        <div class="mobile-cards space-y-4">
          <template x-for="(result, index) in results" :key="'mobile-' + index">
            <div class="bg-white border border-gray-200 rounded-xl p-5 shadow-sm">
              <!-- Card Header -->
              <div class="flex justify-between items-center pb-4 mb-4 border-b border-gray-200">
                <span class="font-display font-semibold text-lg" x-text="result.retailer"></span>
                <span class="text-2xl font-bold"
                      :class="result.cheapest ? 'text-emerald-600' : 'text-brand-500'"
                      x-text="result.delivered_after_promo"></span>
              </div>
              
              <!-- Dealer Badge -->
              <div class="flex items-center gap-2 mb-4">
                <span x-show="result.authorized" 
                      class="inline-block px-2 py-1 rounded text-xs font-semibold uppercase bg-emerald-100 text-emerald-700 border border-emerald-300">
                  Authorized
                </span>
                <span x-show="!result.authorized" 
                      class="inline-block px-2 py-1 rounded text-xs font-semibold uppercase bg-red-50 text-red-600 border border-red-200">
                  Marketplace
                </span>
                <span x-show="!result.authorized" class="text-xs text-red-600 font-medium">Buy at own risk</span>
              </div>
              
              <!-- Price Breakdown -->
              <div class="space-y-2">
                <div class="flex justify-between py-2 border-b border-gray-100">
                  <span class="text-muted font-medium">Advertised Price:</span>
                  <span class="font-semibold" x-text="result.base"></span>
                </div>
                <div x-show="result.current_promotions_applied" class="flex justify-between py-2 border-b border-gray-100">
                  <span class="text-muted font-medium">Promo Price:</span>
                  <span class="font-semibold" x-html="formatPromo(result)"></span>
                </div>
                <div class="flex justify-between py-2 border-b border-gray-100">
                  <span class="text-muted font-medium">Est. Shipping:</span>
                  <span class="font-semibold" x-text="result.shipping"></span>
                </div>
                <div class="flex justify-between py-2 border-b border-gray-100">
                  <span class="text-muted font-medium">Est. Tax:</span>
                  <span class="font-semibold" x-text="result.tax"></span>
                </div>
                <div class="flex justify-between py-3 border-t-2 border-brand-500 mt-2">
                  <span class="font-semibold">Est. Total:</span>
                  <span class="text-xl font-bold"
                        :class="result.cheapest ? 'text-emerald-600' : 'text-brand-500'"
                        x-text="result.delivered_after_promo"></span>
                </div>
                <div x-show="result.price_context" class="flex justify-between py-2 border-b border-gray-100">
                  <span class="text-muted font-medium">Price Context:</span>
                  <span class="font-bold"
                        :class="{
                          'text-emerald-600': result.price_context === 'Value',
                          'text-gray-500': result.price_context === 'Market',
                          'text-blue-600': result.price_context === 'Premium'
                        }"
                        x-text="result.price_context"></span>
                </div>
                <div class="flex justify-between py-2">
                  <span class="text-muted font-medium">Stock Status:</span>
                  <span x-show="result.oos" class="text-red-600 font-semibold">Out of Stock</span>
                  <span x-show="!result.oos" class="text-emerald-600 font-semibold">In Stock</span>
                </div>
              </div>
              
              <!-- Badges -->
              <div x-show="result.wrapper || result.vitola" class="flex gap-2 mt-4 flex-wrap">
                <span x-show="result.wrapper" class="px-3 py-1 rounded-lg bg-gray-100 text-gray-700 text-sm font-semibold" x-text="result.wrapper"></span>
                <span x-show="result.vitola" class="px-3 py-1 rounded-lg bg-sky-100 text-sky-700 text-sm font-semibold" x-text="result.vitola"></span>
              </div>
              
              <!-- Buy Button -->
              <a :href="getTrackingUrl(result)" 
                 target="_blank" 
                 rel="noopener"
                 class="flex items-center justify-center mt-5 py-4 bg-brand-500 hover:bg-brand-600 rounded-xl transition-all duration-200 shadow-md hover:shadow-lg">
                <img src="/static/logo.png" alt="Scout" class="w-8 h-8 object-contain" />
              </a>
            </div>
          </template>
        </div>
        
        <!-- No Results -->
        <div x-show="results.length === 0 && !isSearching" class="text-center py-10">
          <p class="text-muted text-lg">No matching cigars found. Try adjusting your search criteria.</p>
        </div>
      </section>
    </main>
    
    <!-- Footer -->
    <footer class="mt-10 py-5 border-t border-gray-200 text-center text-muted">
      <p class="space-x-2">
        <a href="/best-cigar-box-prices" class="text-brand-500 hover:underline">Best Cigar Box Prices</a>
        <span>|</span>
        <a href="/submit-deal" class="text-brand-500 hover:underline">Submit a Deal</a>
        <span>|</span>
        <a href="/about.html" class="text-brand-500 hover:underline">About</a>
        <span>|</span>
        <a href="/privacy-policy.html" class="text-brand-500 hover:underline">Privacy</a>
        <span>|</span>
        <a href="/terms-of-service.html" class="text-brand-500 hover:underline">Terms</a>
        <span>|</span>
        <a href="/contact.html" class="text-brand-500 hover:underline">Contact</a>
      </p>
      <p class="mt-2">&copy; 2025 Cigar Price Scout. Prices and availability subject to change. Updated daily.</p>
    </footer>
  </div>

  <!-- Alpine.js Component -->
  <script>
    function cigarScout() {
      return {
        // State
        ageVerified: false,
        options: [],
        selection: {
          brand: '',
          line: '',
          wrapper: '',
          vitola: '',
          zip: ''
        },
        authorizedOnly: false,
        isSearching: false,
        showResults: false,
        results: [],
        resultsTitle: '',
        
        // Computed
        get availableLines() {
          if (!this.selection.brand) return [];
          const brand = this.options.find(b => b.brand === this.selection.brand);
          return brand ? brand.lines : [];
        },
        
        get availableWrappers() {
          if (!this.selection.line) return [];
          const brand = this.options.find(b => b.brand === this.selection.brand);
          if (!brand) return [];
          const line = brand.lines.find(l => l.line === this.selection.line);
          if (!line) return [];
          
          const wrappers = new Set();
          line.wrappers.forEach(w => {
            if (w.wrapper) {
              wrappers.add(this.formatWrapperDisplay(w.wrapper, w.wrapper_alias));
            }
          });
          return Array.from(wrappers).sort();
        },
        
        get availableVitolas() {
          if (!this.selection.wrapper) return [];
          const brand = this.options.find(b => b.brand === this.selection.brand);
          if (!brand) return [];
          const line = brand.lines.find(l => l.line === this.selection.line);
          if (!line) return [];
          
          const vitolas = new Set();
          line.wrappers.forEach(w => {
            const displayWrapper = this.formatWrapperDisplay(w.wrapper, w.wrapper_alias);
            if (displayWrapper === this.selection.wrapper && w.vitolas) {
              w.vitolas.forEach(v => vitolas.add(v));
            }
          });
          return Array.from(vitolas).sort();
        },
        
        get boxQtyDisplay() {
          if (!this.selection.brand || !this.selection.line) return '';
          
          const brand = this.options.find(b => b.brand === this.selection.brand);
          if (!brand) return '';
          const line = brand.lines.find(l => l.line === this.selection.line);
          if (!line) return '';
          
          const qtys = new Set();
          line.wrappers.forEach(w => {
            const displayWrapper = this.formatWrapperDisplay(w.wrapper, w.wrapper_alias);
            const wrapperMatch = !this.selection.wrapper || displayWrapper === this.selection.wrapper;
            const vitolaMatch = !this.selection.vitola || (w.vitolas && w.vitolas.includes(this.selection.vitola));
            
            if (wrapperMatch && vitolaMatch && w.box_qtys) {
              w.box_qtys.forEach(qty => qtys.add(Number(qty)));
            }
          });
          
          const sorted = Array.from(qtys).sort((a, b) => a - b);
          if (sorted.length === 1) return `Box of ${sorted[0]}`;
          if (sorted.length > 1) return `Box of ${sorted.join(', ')}`;
          return '';
        },
        
        get canSearch() {
          return this.selection.brand && this.selection.line && this.selection.zip;
        },
        
        get hasFilters() {
          return this.filterChips.length > 0;
        },
        
        get filterChips() {
          const chips = [];
          if (this.selection.brand) chips.push(`Brand: ${this.selection.brand}`);
          if (this.selection.line) chips.push(`Line: ${this.selection.line}`);
          if (this.selection.wrapper) chips.push(`Wrapper: ${this.selection.wrapper}`);
          if (this.selection.vitola) chips.push(`Vitola: ${this.selection.vitola}`);
          return chips;
        },
        
        // Get cheapest in-stock result for answer block
        getCheapestResult() {
          if (!this.results || this.results.length === 0) return null;
          
          // Filter to in-stock items first
          const inStockResults = this.results.filter(r => !r.oos);
          if (inStockResults.length === 0) return null;
          
          // Find the cheapest by delivered_after_promo price
          return inStockResults.reduce((min, r) => {
            const minPrice = parseFloat(min.delivered_after_promo.replace('$', '').replace(',', ''));
            const rPrice = parseFloat(r.delivered_after_promo.replace('$', '').replace(',', ''));
            return rPrice < minPrice ? r : min;
          });
        },
        
        // Methods
        async init() {
          try {
            const response = await fetch('/options');
            const data = await response.json();
            this.options = data.brands || [];
            console.log(`Loaded ${this.options.length} brands`);
          } catch (error) {
            console.error('Failed to load options:', error);
          }
        },
        
        confirmAge() {
          this.ageVerified = true;
        },
        
        denyAge() {
          alert('You must be 21 or older to access this site.');
          window.location.href = 'https://www.google.com';
        },
        
        onBrandChange() {
          this.selection.line = '';
          this.selection.wrapper = '';
          this.selection.vitola = '';
        },
        
        onLineChange() {
          this.selection.wrapper = '';
          this.selection.vitola = '';
        },
        
        onWrapperChange() {
          this.selection.vitola = '';
        },
        
        onVitolaChange() {
          // Could trigger auto-search or other actions
        },
        
        formatWrapperDisplay(wrapper, alias) {
          if (!wrapper) return '';
          if (!alias || alias.trim() === '' || alias.toLowerCase() === wrapper.toLowerCase()) return wrapper;
          return `${alias} (${wrapper})`;
        },
        
        extractActualWrapper(displayWrapper) {
          if (!displayWrapper) return '';
          const match = displayWrapper.match(/\(([^)]+)\)$/);
          return match ? match[1] : displayWrapper;
        },
        
        async search() {
          if (!this.canSearch) return;
          
          this.isSearching = true;
          this.showResults = false;
          
          try {
            const params = new URLSearchParams({
              brand: this.selection.brand,
              line: this.selection.line,
              zip: this.selection.zip
            });
            
            if (this.selection.wrapper) {
              params.append('wrapper', this.extractActualWrapper(this.selection.wrapper));
            }
            if (this.selection.vitola) {
              params.append('vitola', this.selection.vitola);
            }
            if (this.authorizedOnly) {
              params.append('authorized_only', 'true');
            }
            
            const response = await fetch(`/compare?${params.toString()}`);
            const data = await response.json();
            
            // Sort by price
            this.results = (data.results || []).sort((a, b) => {
              return parseFloat(a.delivered_after_promo.replace('$', '')) - 
                     parseFloat(b.delivered_after_promo.replace('$', ''));
            });
            
            // Build title
            let titleParts = [data.brand, data.line];
            if (data.wrapper) titleParts.push(data.wrapper);
            if (data.vitola) titleParts.push(data.vitola);
            if (this.results.length > 0) {
              titleParts.push(`Box of ${this.results[0].box_qty}`);
            }
            this.resultsTitle = `${titleParts.join(', ')} - Price Comparison`;
            
            
            this.showResults = true;
            
            // Scroll to results
            this.$nextTick(() => {
              document.querySelector('[x-show="showResults"]')?.scrollIntoView({ behavior: 'smooth' });
            });
            
          } catch (error) {
            console.error('Search failed:', error);
            alert('Search failed. Please try again.');
          } finally {
            this.isSearching = false;
          }
        },
        
        
        formatPromo(result) {
          if (!result.current_promotions_applied) {
            return '<span class="text-gray-400">—</span>';
          }
          
          const parts = result.current_promotions_applied.split('|');
          const displayText = parts[0];
          const code = parts[1] || '';
          const discountMatch = displayText.match(/\[([^\]]+)\]/);
          
          if (discountMatch) {
            const discount = discountMatch[1];
            let html = `<div class="text-red-600 font-bold">${discount}</div>`;
            if (code) html += `<div class="text-sm text-gray-600">Code: ${code}</div>`;
            return html;
          }
          
          return '<span class="text-gray-400">—</span>';
        },
        
        getTrackingUrl(result) {
          const cid = result.product.replace(/\s+/g, '-').toLowerCase();
          return `/go?retailer=${encodeURIComponent(result.retailer)}&cid=${encodeURIComponent(cid)}&url=${encodeURIComponent(result.url)}`;
        },
        
        reportIssue() {
          const searchContext = this.buildSearchContext();
          sessionStorage.setItem('reportIssueContext', JSON.stringify({
            searchContext,
            currentUrl: window.location.href,
            timestamp: new Date().toISOString(),
            currentResults: this.results
          }));
          window.location.href = '/report-data-issue.html';
        },
        
        buildSearchContext() {
          if (!this.selection.brand || !this.selection.line) {
            return 'General website feedback (no specific search active)';
          }
          
          let context = `${this.selection.brand} ${this.selection.line}`;
          if (this.selection.wrapper) context += ` (${this.selection.wrapper} wrapper)`;
          if (this.selection.vitola) context += ` ${this.selection.vitola}`;
          if (this.selection.zip) context += ` - ZIP: ${this.selection.zip}`;
          if (this.authorizedOnly) context += ' (Authorized dealers only)';
          
          return context;
        }
      };
    }
  </script>
</body>
</html>
