<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Cigar Price Scout - Find the Best Cigar Deals with Wrapper & Vitola Search</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Compare cigar prices across 35+ online retailers. Search by brand, wrapper type, vitola, and size to find the best deals on premium cigars with shipping and tax calculations." />
    <meta name="keywords" content="cigar prices, cigar deals, wrapper types, vitola sizes, Connecticut, Maduro, Habano, cigar comparison, online cigar shopping" />
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="Cigar Price Scout - Best Cigar Price Comparison" />
    <meta property="og:description" content="Compare cigar prices across 35+ retailers. Filter by wrapper type, vitola, and size to find your perfect cigar at the best price." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://cigarpricescout.com" />
    <meta property="og:image" content="https://cigarpricescout.com/static/cigar-scout-social.png" />
    
    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Cigar Price Scout - Find the Best Cigar Deals" />
    <meta name="twitter:description" content="Compare prices on premium cigars by wrapper type, vitola, and size across 35+ online retailers." />
    <meta name="twitter:image" content="https://cigarpricescout.com/static/cigar-scout-social.png" />
    
    <!-- Schema.org Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Cigar Price Scout",
      "description": "Compare cigar prices across multiple online retailers with advanced filtering by wrapper type, vitola, and size",
      "url": "https://cigarpricescout.com",
      "applicationCategory": "Shopping",
      "operatingSystem": "Any",
      "offers": {
        "@type": "Offer",
        "category": "Cigars",
        "availability": "https://schema.org/InStock"
      }
    }
    </script>
    
    <!-- Sherlock-esque fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet" />
    
    <style>
      :root{
        --ink:#111;
        --muted:#4b5563;
        --rule:#e5e7eb;
        --accent:#7c5c2e;
      }
      body{
        margin:0;
        color:var(--ink);
        background:#faf7f2;
        font-family:"Cormorant Garamond", serif;
        font-size:18px;
        line-height:1.5;
      }
      .wrap{max-width:900px;margin:0 auto;padding:0 20px}
      
      /* Header: scout hat, title, tagline stacked and centered */
      .heroheader{
        display:flex;flex-direction:column;align-items:center;justify-content:center;
        gap:8px;padding:28px 0 10px;text-align:center;
      }
      .scout-hat{width:80px;height:60px}
      .brandname{
        font-family:"Cinzel", serif;
        font-weight:700;
        letter-spacing:.4px;
        font-size:28px;
      }
      .tag{
        font-style:italic;
        color:var(--muted);
        font-size:20px;
        margin-top:2px;
      }
      
      /* Enhanced Picker with wrapper support */
      .picker{
        display:grid;
        grid-template-columns:1fr 1fr 1fr 1fr 140px 200px;
        gap:10px;margin:18px auto;
      }
      .picker select,.picker input{
        padding:12px 14px;border:1px solid var(--rule);border-radius:12px;background:#fff;
        font-family:"Cormorant Garamond", serif;font-size:18px;
      }
      .cta{border:none;border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
      .cta-primary{background:var(--accent);color:#fff}
      .cta-primary:hover{filter:brightness(.95)}
      .cta:disabled{opacity:0.5;cursor:not-allowed}
      .cta svg{width:18px;height:18px}
      .chips{display:flex;gap:8px;justify-content:center;margin-top:12px;flex-wrap:wrap}
      .chip{font-size:14px;padding:6px 10px;border-radius:999px;border:1px solid var(--rule);background:#fff;color:#374151}
      h2{font-family:"Cinzel", serif;font-weight:700;letter-spacing:.3px;margin:18px 0 8px;font-size:24px}
      
      /* Clean, Professional Table Styling with Enhanced Readability */
      table{
        width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--rule);
        border-radius:12px;overflow:hidden;margin-top:20px;
        box-shadow:0 1px 3px rgba(0,0,0,0.05);
      }
      th,td{
        padding:16px 18px;border-bottom:1px solid var(--rule);text-align:left;
        font-size:19px;line-height:1.5;
      }
      th{
        background:#fcfbf9;color:var(--ink);font-family:"Cinzel", serif;
        font-weight:600;font-size:17px;letter-spacing:0.3px;
      }
      td{color:var(--ink);background:#fff}
      
      /* Enhanced Product Details Spacing */
      .product-details{
        display:flex;
        flex-direction:column;
        gap:4px;
        line-height:1.4;
      }
      .product-name{
        font-weight:600;
        font-size:18px;
        color:var(--ink);
      }
      .product-specs{
        display:flex;
        gap:8px;
        flex-wrap:wrap;
        font-size:16px;
        color:var(--muted);
      }
      
      /* Authorized Dealer Indicators */
      .retailer-info{
        display:flex;
        align-items:center;
        gap:8px;
      }
      .auth-badge{
        display:inline-block;
        padding:3px 8px;
        border-radius:6px;
        font-size:12px;
        font-weight:600;
        text-transform:uppercase;
      }
      .auth-badge.authorized{
        background:#dcfce7;
        color:#166534;
        border:1px solid #bbf7d0;
      }
      .auth-badge.unauthorized{
        background:#fef3c7;
        color:#92400e;
        border:1px solid #fde68a;
      }
      
      /* Status indicators */
      .oos{color:#dc2626;font-weight:600;font-size:13px;text-transform:uppercase}
      .best{color:#059669;font-weight:700;font-size:13px;text-transform:uppercase}
      
      /* Links styling */
      td a{color:var(--accent);text-decoration:none;font-weight:600;font-size:18px}
      td a:hover{text-decoration:underline}
      
      /* Wrapper and vitola badges */
      .wrapper-badge{
        display:inline-block;
        background:#f3f4f6;
        color:#374151;
        padding:5px 10px;
        border-radius:8px;
        font-size:14px;
        font-weight:600;
        margin-right:6px;
      }
      .vitola-badge{
        display:inline-block;
        background:#e0f2fe;
        color:#0369a1;
        padding:5px 10px;
        border-radius:8px;
        font-size:14px;
        font-weight:600;
      }
      
      /* Price columns styling */
      .price-cell{
        font-weight:600;
        font-size:18px;
      }
      .total-price{
        font-weight:700;
        font-size:19px;
        color:var(--accent);
      }
      
      /* Responsive design */
      @media(max-width:768px){
        .picker{
          grid-template-columns:1fr;
          gap:12px;
        }
        .heroheader{padding:20px 0 8px}
        .brandname{font-size:24px}
        .tag{font-size:18px}
        table{font-size:15px}
        th,td{padding:10px 12px}
      }
      
      /* Footer */
      .footer{
        margin-top:40px;
        padding:20px 0;
        border-top:1px solid var(--rule);
        text-align:center;
        color:var(--muted);
        font-size:16px;
      }
      .footer a{color:var(--accent);text-decoration:none}
      .footer a:hover{text-decoration:underline}
    </style>
  </head>
  
  <body>
    <div class="wrap">
      <header class="heroheader">
        <svg class="scout-hat" viewBox="0 0 80 60" fill="none">
          <path d="M10 45 C10 35, 20 25, 40 25 C60 25, 70 35, 70 45 L70 50 C70 52, 68 54, 65 54 L15 54 C12 54, 10 52, 10 50 Z" fill="#7c5c2e"/>
          <ellipse cx="40" cy="25" rx="25" ry="8" fill="#5d4e37"/>
          <path d="M20 30 C25 28, 35 27, 40 28 C45 27, 55 28, 60 30" stroke="#4a3728" stroke-width="2" fill="none"/>
        </svg>
        <h1 class="brandname">Cigar Price Scout</h1>
        <p class="tag">Find the best cigar deals by wrapper, vitola & size</p>
      </header>
      
      <main>
        <section class="picker">
          <select id="brandSelect" aria-label="Select cigar brand">
            <option value="">Select Brand...</option>
          </select>
          
          <select id="lineSelect" disabled aria-label="Select cigar line">
            <option value="">Select Line...</option>
          </select>
          
          <select id="wrapperSelect" disabled aria-label="Select wrapper type">
            <option value="">Any Wrapper...</option>
          </select>
          
          <select id="vitolaSelect" disabled aria-label="Select vitola">
            <option value="">Any Vitola...</option>
          </select>
          
          <input type="text" id="zipInput" placeholder="ZIP code" aria-label="ZIP code for shipping calculation" />
          
          <button class="cta cta-primary" id="searchBtn" disabled>
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
            Find Deals
          </button>
        </section>
        
        <div class="chips" id="filterChips"></div>
        
        <section id="results" style="display:none">
          <h2 id="resultsTitle">Price Comparison Results</h2>
          <table id="resultsTable">
            <thead>
              <tr>
                <th>Retailer</th>
                <th>Product Details</th>
                <th>Base Price</th>
                <th>Shipping</th>
                <th>Tax</th>
                <th>Total</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>
      </main>
      
      <footer class="footer">
        <p>
          <a href="/about.html">About</a> | 
          <a href="/privacy-policy.html">Privacy</a> | 
          <a href="/terms-of-service.html">Terms</a> | 
          <a href="/contact.html">Contact</a>
        </p>
        <p>&copy; 2025 Cigar Price Scout. Prices and availability subject to change.</p>
      </footer>
    </div>

    <script>
      let optionsData = null;
      let currentSelection = {
        brand: '',
        line: '',
        wrapper: '',
        vitola: ''
      };

      // DOM elements
      const brandSelect = document.getElementById('brandSelect');
      const lineSelect = document.getElementById('lineSelect');
      const wrapperSelect = document.getElementById('wrapperSelect');
      const vitolaSelect = document.getElementById('vitolaSelect');
      const zipInput = document.getElementById('zipInput');
      const searchBtn = document.getElementById('searchBtn');
      const filterChips = document.getElementById('filterChips');
      const resultsSection = document.getElementById('results');
      const resultsTitle = document.getElementById('resultsTitle');
      const resultsTable = document.getElementById('resultsTable');

      // Load options on page load
      async function loadOptions() {
        try {
          const response = await fetch('/options');
          const data = await response.json();
          optionsData = data.brands;
          populateBrandSelect();
        } catch (error) {
          console.error('Error loading options:', error);
        }
      }

      function populateBrandSelect() {
        brandSelect.innerHTML = '<option value="">Select Brand...</option>';
        optionsData.forEach(brand => {
          const option = document.createElement('option');
          option.value = brand.brand;
          option.textContent = brand.brand;
          brandSelect.appendChild(option);
        });
      }

      function populateLineSelect() {
        lineSelect.innerHTML = '<option value="">Select Line...</option>';
        lineSelect.disabled = !currentSelection.brand;
        
        if (currentSelection.brand) {
          const brand = optionsData.find(b => b.brand === currentSelection.brand);
          if (brand) {
            brand.lines.forEach(line => {
              const option = document.createElement('option');
              option.value = line.line;
              option.textContent = line.line;
              lineSelect.appendChild(option);
            });
          }
        }
      }

      function populateWrapperSelect() {
        wrapperSelect.innerHTML = '<option value="">Any Wrapper...</option>';
        wrapperSelect.disabled = !currentSelection.line;
        
        if (currentSelection.brand && currentSelection.line) {
          const brand = optionsData.find(b => b.brand === currentSelection.brand);
          const line = brand?.lines.find(l => l.line === currentSelection.line);
          
          if (line) {
            // Get unique wrappers
            const wrappers = [...new Set(line.wrappers.map(w => w.wrapper).filter(w => w))];
            wrappers.forEach(wrapper => {
              const option = document.createElement('option');
              option.value = wrapper;
              option.textContent = wrapper;
              wrapperSelect.appendChild(option);
            });
          }
        }
      }

      function populateVitolaSelect() {
        vitolaSelect.innerHTML = '<option value="">Any Vitola...</option>';
        vitolaSelect.disabled = !currentSelection.line;
        
        if (currentSelection.brand && currentSelection.line) {
          const brand = optionsData.find(b => b.brand === currentSelection.brand);
          const line = brand?.lines.find(l => l.line === currentSelection.line);
          
          if (line) {
            // Get unique vitolas
            const vitolas = [...new Set(line.wrappers.flatMap(w => w.vitolas).filter(v => v))];
            vitolas.forEach(vitola => {
              const option = document.createElement('option');
              option.value = vitola;
              option.textContent = vitola;
              vitolaSelect.appendChild(option);
            });
          }
        }
      }

      function updateFilterChips() {
        const chips = [];
        if (currentSelection.brand) chips.push(`Brand: ${currentSelection.brand}`);
        if (currentSelection.line) chips.push(`Line: ${currentSelection.line}`);
        if (currentSelection.wrapper) chips.push(`Wrapper: ${currentSelection.wrapper}`);
        if (currentSelection.vitola) chips.push(`Vitola: ${currentSelection.vitola}`);
        
        filterChips.innerHTML = chips.map(chip => 
          `<span class="chip">${chip}</span>`
        ).join('');
      }

      function updateSearchButton() {
        const canSearch = currentSelection.brand && currentSelection.line;
        searchBtn.disabled = !canSearch;
      }

      // Event listeners
      brandSelect.addEventListener('change', (e) => {
        currentSelection.brand = e.target.value;
        currentSelection.line = '';
        currentSelection.wrapper = '';
        currentSelection.vitola = '';
        
        lineSelect.value = '';
        wrapperSelect.value = '';
        vitolaSelect.value = '';
        
        populateLineSelect();
        populateWrapperSelect();
        populateVitolaSelect();
        updateFilterChips();
        updateSearchButton();
      });

      lineSelect.addEventListener('change', (e) => {
        currentSelection.line = e.target.value;
        currentSelection.wrapper = '';
        currentSelection.vitola = '';
        
        wrapperSelect.value = '';
        vitolaSelect.value = '';
        
        populateWrapperSelect();
        populateVitolaSelect();
        updateFilterChips();
        updateSearchButton();
      });

      wrapperSelect.addEventListener('change', (e) => {
        currentSelection.wrapper = e.target.value;
        updateFilterChips();
      });

      vitolaSelect.addEventListener('change', (e) => {
        currentSelection.vitola = e.target.value;
        updateFilterChips();
      });

      searchBtn.addEventListener('click', async () => {
        if (!currentSelection.brand || !currentSelection.line) return;
        
        const params = new URLSearchParams({
          brand: currentSelection.brand,
          line: currentSelection.line,
          zip: zipInput.value
        });
        
        if (currentSelection.wrapper) params.append('wrapper', currentSelection.wrapper);
        if (currentSelection.vitola) params.append('vitola', currentSelection.vitola);
        
        try {
          searchBtn.disabled = true;
          searchBtn.textContent = 'Searching...';
          
          const response = await fetch(`/compare?${params}`);
          const data = await response.json();
          
          displayResults(data);
        } catch (error) {
          console.error('Search error:', error);
          alert('Search failed. Please try again.');
        } finally {
          searchBtn.disabled = false;
          searchBtn.innerHTML = `
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
            Find Deals
          `;
        }
      });

      function displayResults(data) {
        if (!data.results || data.results.length === 0) {
          resultsTitle.textContent = 'No results found';
          resultsTable.querySelector('tbody').innerHTML = '<tr><td colspan="7">No matching cigars found.</td></tr>';
          resultsSection.style.display = 'block';
          return;
        }
        
        // Update title
        let titleParts = [data.brand, data.line];
        if (data.wrapper) titleParts.push(data.wrapper);
        if (data.vitola) titleParts.push(data.vitola);
        resultsTitle.textContent = `${titleParts.join(' ')} - Price Comparison`;
        
        // Build table rows
        const tbody = resultsTable.querySelector('tbody');
        tbody.innerHTML = data.results.map(result => `
          <tr>
            <td>
              <div class="retailer-info">
                <a href="${result.url}" target="_blank">${result.retailer}</a>
                <span class="auth-badge ${result.authorized ? 'authorized' : 'unauthorized'}">
                  ${result.authorized ? 'Authorized' : 'Marketplace'}
                </span>
              </div>
            </td>
            <td>
              <div class="product-details">
                <div class="product-name">${result.product}</div>
                <div class="product-specs">
                  ${result.wrapper ? `<span class="wrapper-badge">${result.wrapper}</span>` : ''}
                  ${result.vitola ? `<span class="vitola-badge">${result.vitola}</span>` : ''}
                  <span>Size: ${result.size}</span>
                </div>
              </div>
            </td>
            <td class="price-cell">${result.base}</td>
            <td class="price-cell">${result.shipping}</td>
            <td class="price-cell">${result.tax}</td>
            <td class="price-cell total-price">${result.delivered_after_promo}</td>
            <td>
              ${result.oos ? '<span class="oos">Out of Stock</span>' : ''}
              ${result.cheapest ? '<span class="best">Best Deal</span>' : ''}
            </td>
          </tr>
        `).join('');
        
        resultsSection.style.display = 'block';
        resultsSection.scrollIntoView({ behavior: 'smooth' });
      }

      // Initialize
      loadOptions();
    </script>
  </body>
</html>